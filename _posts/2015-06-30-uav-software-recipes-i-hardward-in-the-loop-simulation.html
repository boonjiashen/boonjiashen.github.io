---
layout: post
title: 'UAV Software Recipes I: Hardward-in-the-loop simulation'
author: Jia Shen Boon
tags: 
modified_time: '2015-06-30T10:01:37.577-07:00'
blogger_id: tag:blogger.com,1999:blog-6651978490904982752.post-871585390835275053
blogger_orig_url: http://blog.jiashen.me/2015/06/uav-software-recipes-i-hardward-in-loop.html
---

<div class="separator" style="clear: both; text-align: center;"></div><h2></h2><table align="center" cellpadding="0" cellspacing="0" class="tr-caption-container" style="margin-left: auto; margin-right: auto; text-align: center;"><tbody><tr><td style="text-align: center;"><a href="https://blog.adafruit.com/wp-content/uploads/2014/10/NewImage183.png" imageanchor="1" style="margin-left: auto; margin-right: auto;"><img border="0" height="239" src="https://blog.adafruit.com/wp-content/uploads/2014/10/NewImage183.png" width="320" /></a></td></tr><tr><td class="tr-caption" style="text-align: center;">3DRobotics IRIS+</td></tr></tbody></table><h2><span style="background-color: white; color: #373d49; font-family: 'Source Sans Pro', 'Helvetica Neue', Helvetica, Arial, sans-serif; font-size: 2.05714rem; line-height: 3rem;">Background</span></h2><div><div style="-webkit-font-feature-settings: 'kern' 1, 'onum' 1, 'liga' 1; background-color: white; box-sizing: border-box; color: #373d49; font-family: Georgia, Cambria, serif; font-size: 14px; line-height: 28px; margin-bottom: 1.33999rem; padding-top: 0.66001rem;">Hey everybody! Today I want to write about simulating an&nbsp;<span style="box-sizing: border-box; font-weight: 700;">unmanned aerial vehicle</span>&nbsp;(UAV, popularly known as "drones") with&nbsp;<span style="box-sizing: border-box; font-weight: 700;">hardware in the loop</span>&nbsp;(HIL, HITL). I'm not sure about the nitty gritty details but as far as I can tell, HITL is when you place the flight stack that sits in your flight controller unit (FCU) in a simulated environment, i.e. you inject simulated sensory inputs into the flight stack and ask the flight stack to produce actuator outputs. This scenario is the same as&nbsp;<span style="box-sizing: border-box; font-weight: 700;">software in the loop</span>&nbsp;(SITL), except that in SITL, the flight stack in question is an instance that sits in your workstation, e.g. your laptop, rather than the actual one in your flight controller unit.</div><div style="-webkit-font-feature-settings: 'kern' 1, 'onum' 1, 'liga' 1; background-color: white; box-sizing: border-box; color: #373d49; font-family: Georgia, Cambria, serif; font-size: 14px; line-height: 28px; margin-bottom: 1.33999rem; padding-top: 0.66001rem;"><span style="box-sizing: border-box; font-weight: 700;">Why would you pick HITL over SITL?</span>&nbsp;For one thing, since HITL involves the actual flight stack that you'll be flying with, it should give simulated results that are closer to real world flight results. On the other hand, SITL can be done with your laptop and nothing else; HITL requires you to connect your laptop to the FCU, which can be a pain if your UAV is bulky and cumbersome.</div><div style="-webkit-font-feature-settings: 'kern' 1, 'onum' 1, 'liga' 1; background-color: white; box-sizing: border-box; color: #373d49; font-family: Georgia, Cambria, serif; font-size: 14px; line-height: 28px; margin-bottom: 1.33999rem; padding-top: 0.66001rem;">Again, I'm not 100% sure on the above, but it makes sense to me.</div><div style="-webkit-font-feature-settings: 'kern' 1, 'onum' 1, 'liga' 1; background-color: white; box-sizing: border-box; color: #373d49; font-family: Georgia, Cambria, serif; font-size: 14px; line-height: 28px; margin-bottom: 1.33999rem; padding-top: 0.66001rem;">To provide some context, I've been working as a research assistant at a robotics lab at Wisconsin. These recipes are the crystallization of my poking around existing software libraries in the UAV world.</div><h1 id="uav-system-specifications" style="-webkit-font-feature-settings: 'dlig' 1, 'liga' 1, 'lnum' 1, 'kern' 1; background-color: white; box-sizing: border-box; color: #373d49; font-family: 'Source Sans Pro', 'Helvetica Neue', Helvetica, Arial, sans-serif; font-size: 2.05714rem; line-height: 3rem; margin: 0px 0px 0.21999rem; padding-top: 0.78001rem;">UAV system specifications</h1><div style="-webkit-font-feature-settings: 'kern' 1, 'onum' 1, 'liga' 1; background-color: white; box-sizing: border-box; color: #373d49; font-family: Georgia, Cambria, serif; font-size: 14px; line-height: 28px; margin-bottom: 1.33999rem; padding-top: 0.66001rem;">Here's the hardware related specifications that I'm running on. You'll need the PX4 flight stack for this HITL, but everything else is swappable. For example, you can go with another FCU besides the Pixhawk.</div><ul style="background-color: white; box-sizing: border-box; color: #373d49; font-family: Georgia, Cambria, serif; font-size: 14px; line-height: 28px; margin-bottom: 0.83999rem; padding-top: 0.16001rem;"><li style="-webkit-font-feature-settings: 'kern' 1, 'onum' 1, 'liga' 1; box-sizing: border-box; margin-left: 1rem;">3DRobotics IRIS+ chassis</li><li style="-webkit-font-feature-settings: 'kern' 1, 'onum' 1, 'liga' 1; box-sizing: border-box; margin-left: 1rem;">3DRobotics Pixhawk FCU</li><li style="-webkit-font-feature-settings: 'kern' 1, 'onum' 1, 'liga' 1; box-sizing: border-box; margin-left: 1rem;">PX4 flight stack [<a href="https://github.com/PX4/Firmware" style="background: 0px 0px; box-sizing: border-box; color: #a0aabf; cursor: pointer;">Github</a>] [<a href="https://pixhawk.org/start" style="background: 0px 0px; box-sizing: border-box; color: #a0aabf; cursor: pointer;">Pixhawk</a>]</li><li style="-webkit-font-feature-settings: 'kern' 1, 'onum' 1, 'liga' 1; box-sizing: border-box; margin-left: 1rem;">FrSky Taranis Plus remote control transmitter (RC transmitter)</li></ul><div style="-webkit-font-feature-settings: 'kern' 1, 'onum' 1, 'liga' 1; background-color: white; box-sizing: border-box; color: #373d49; font-family: Georgia, Cambria, serif; font-size: 14px; line-height: 28px; margin-bottom: 1.33999rem; padding-top: 0.66001rem;">Note: the HITL that I'll be describing&nbsp;<span style="box-sizing: border-box; font-weight: 700;">DOES NOT</span>&nbsp;work with the Ardupilot/Arducopter flight stack. At the time of writing, Ardupilot only supports SITL. If you're using it, either switch to PX4 or be content with SITL.</div><h1 id="software-specifications" style="-webkit-font-feature-settings: 'dlig' 1, 'liga' 1, 'lnum' 1, 'kern' 1; background-color: white; box-sizing: border-box; color: #373d49; font-family: 'Source Sans Pro', 'Helvetica Neue', Helvetica, Arial, sans-serif; font-size: 2.05714rem; line-height: 3rem; margin: 0px 0px 0.21999rem; padding-top: 0.78001rem;">Software specifications</h1><ul style="background-color: white; box-sizing: border-box; color: #373d49; font-family: Georgia, Cambria, serif; font-size: 14px; line-height: 28px; margin-bottom: 0.83999rem; padding-top: 0.16001rem;"><li style="-webkit-font-feature-settings: 'kern' 1, 'onum' 1, 'liga' 1; box-sizing: border-box; margin-left: 1rem;">Ubuntu 14.04.1 on the workstation. I'll refer to this workstation as the ground control station or GCS.</li><li style="-webkit-font-feature-settings: 'kern' 1, 'onum' 1, 'liga' 1; box-sizing: border-box; margin-left: 1rem;">jMAVSim simulator [<a href="https://github.com/DrTon/jMAVSim" style="background: 0px 0px; box-sizing: border-box; color: #a0aabf; cursor: pointer;">Github</a>] [<a href="https://gitter.im/DrTon/jMAVSim" style="background: 0px 0px; box-sizing: border-box; color: #a0aabf; cursor: pointer;">Gitter</a>]</li><li style="-webkit-font-feature-settings: 'kern' 1, 'onum' 1, 'liga' 1; box-sizing: border-box; margin-left: 1rem;">qgroundcontrol GCS software [<a href="http://qgroundcontrol.org/" style="background: 0px 0px; box-sizing: border-box; color: #a0aabf; cursor: pointer;">qgroundcontrol</a>]</li></ul><h1 id="how-to-run-the-simulator" style="-webkit-font-feature-settings: 'dlig' 1, 'liga' 1, 'lnum' 1, 'kern' 1; background-color: white; box-sizing: border-box; color: #373d49; font-family: 'Source Sans Pro', 'Helvetica Neue', Helvetica, Arial, sans-serif; font-size: 2.05714rem; line-height: 3rem; margin: 0px 0px 0.21999rem; padding-top: 0.78001rem;">How to run the simulator</h1><ol style="background-color: white; box-sizing: border-box; color: #373d49; font-family: Georgia, Cambria, serif; font-size: 14px; line-height: 28px; margin-bottom: 0.83999rem; padding-top: 0.16001rem;"><li style="-webkit-font-feature-settings: 'kern' 1, 'onum' 1, 'liga' 1; box-sizing: border-box; margin-left: 1rem;">Flash PX4 firmware to the Pixhawk using qgroundcontrol.</li><li style="-webkit-font-feature-settings: 'kern' 1, 'onum' 1, 'liga' 1; box-sizing: border-box; margin-left: 1rem;">Perform initial calibration of PX4 using qgroundcontrol. Make sure to assign a channel to flight modes, because you'll have to set the mode to manual later during flight.</li><li style="-webkit-font-feature-settings: 'kern' 1, 'onum' 1, 'liga' 1; box-sizing: border-box; margin-left: 1rem;">Change&nbsp;<code style="background-color: #f9f2f4; border-radius: 4px; box-sizing: border-box; color: #c7254e; font-family: monospace, monospace; font-size: 1em; padding: 2px 4px;">SYS_AUTOSTART</code>&nbsp;parameter on PX4 to 1001.</li><li style="-webkit-font-feature-settings: 'kern' 1, 'onum' 1, 'liga' 1; box-sizing: border-box; margin-left: 1rem;">Connect IRIS+ microUSB to GCS' USB</li><li style="-webkit-font-feature-settings: 'kern' 1, 'onum' 1, 'liga' 1; box-sizing: border-box; margin-left: 1rem;">Compile and run&nbsp;<code style="background-color: #f9f2f4; border-radius: 4px; box-sizing: border-box; color: #c7254e; font-family: monospace, monospace; font-size: 1em; padding: 2px 4px;">Simulator.java</code>.<pre style="background: linear-gradient(rgb(255, 255, 255) 0px, rgb(255, 255, 255) 0.75rem, rgb(245, 247, 250) 0.75rem, rgb(245, 247, 250) 2.75rem, rgb(255, 255, 255) 2.75rem, rgb(255, 255, 255) 4rem); border-radius: 4px; border: 1px solid rgb(211, 218, 234); box-sizing: border-box; color: #333333; font-family: monospace, monospace; font-size: 1rem; line-height: 2rem; margin-bottom: 1.33999rem; overflow: auto; padding: 0.66001rem 9.5px 9.5px; word-break: break-all; word-wrap: break-word;"><code style="background-color: transparent; border-radius: 0px; box-sizing: border-box; color: inherit; font-family: monospace, monospace; font-size: inherit; padding: 0px; white-space: pre-wrap;"><span class="hljs-prompt" style="box-sizing: border-box;">&gt;&gt;</span> cd &lt;<span class="hljs-constant" style="box-sizing: border-box; color: #b58900;">WHATEVER_YOUR_JMAVSIM_DIRECTORY_IS</span>&gt;<br />&gt;&gt; ant  <span class="hljs-comment" style="box-sizing: border-box; color: #586e75;"># build simulator</span><br /><span class="hljs-prompt" style="box-sizing: border-box;">&gt;&gt;</span> java -cp lib/*<span class="hljs-symbol" style="box-sizing: border-box; color: #cb4b16;">:out/production/jmavsim</span>.jar me.drton.jmavsim.<span class="hljs-constant" style="box-sizing: border-box; color: #b58900;">Simulator</span>  <span class="hljs-comment" style="box-sizing: border-box; color: #586e75;"># run simulator</span><br /></code></pre></li><li style="-webkit-font-feature-settings: 'kern' 1, 'onum' 1, 'liga' 1; box-sizing: border-box; margin-left: 1rem;">Turn on RC transmitter and flip mode to manual. You should see something like:<pre style="background: linear-gradient(rgb(255, 255, 255) 0px, rgb(255, 255, 255) 0.75rem, rgb(245, 247, 250) 0.75rem, rgb(245, 247, 250) 2.75rem, rgb(255, 255, 255) 2.75rem, rgb(255, 255, 255) 4rem); border-radius: 4px; border: 1px solid rgb(211, 218, 234); box-sizing: border-box; color: #333333; font-family: monospace, monospace; font-size: 1rem; line-height: 2rem; margin-bottom: 1.33999rem; overflow: auto; padding: 0.66001rem 9.5px 9.5px; word-break: break-all; word-wrap: break-word;"><code style="background-color: transparent; border-radius: 0px; box-sizing: border-box; color: inherit; font-family: monospace, monospace; font-size: inherit; padding: 0px; white-space: pre-wrap;"><span class="hljs-string" style="box-sizing: border-box; color: #2aa198;">MSG:</span> Flight <span class="hljs-string" style="box-sizing: border-box; color: #2aa198;">mode:</span> MANUAL<br /></code></pre></li><li style="-webkit-font-feature-settings: 'kern' 1, 'onum' 1, 'liga' 1; box-sizing: border-box; margin-left: 1rem;">Arm Pixhawk via RC transmitter. You should see something like the following. Notice that it states<code style="background-color: #f9f2f4; border-radius: 4px; box-sizing: border-box; color: #c7254e; font-family: monospace, monospace; font-size: 1em; padding: 2px 4px;">TAKEOFF DETECTED</code>&nbsp;even though my throttle stick is still down, which is weird.<pre style="background: linear-gradient(rgb(255, 255, 255) 0px, rgb(255, 255, 255) 0.75rem, rgb(245, 247, 250) 0.75rem, rgb(245, 247, 250) 2.75rem, rgb(255, 255, 255) 2.75rem, rgb(255, 255, 255) 4rem); border-radius: 4px; border: 1px solid rgb(211, 218, 234); box-sizing: border-box; color: #333333; font-family: monospace, monospace; font-size: 1rem; line-height: 2rem; margin-bottom: 1.33999rem; overflow: auto; padding: 0.66001rem 9.5px 9.5px; word-break: break-all; word-wrap: break-word;"><code style="background-color: transparent; border-radius: 0px; box-sizing: border-box; color: inherit; font-family: monospace, monospace; font-size: inherit; padding: 0px; white-space: pre-wrap;"><span class="hljs-string" style="box-sizing: border-box; color: #2aa198;">MSG:</span> ARMED by RC<br /><span class="hljs-string" style="box-sizing: border-box; color: #2aa198;">MSG:</span> <span class="hljs-string" style="box-sizing: border-box; color: #2aa198;">home:</span> <span class="hljs-number" style="box-sizing: border-box; color: #2aa198;">55.7533878</span>, <span class="hljs-number" style="box-sizing: border-box; color: #2aa198;">37.6253804</span>, <span class="hljs-number" style="box-sizing: border-box; color: #2aa198;">5.50</span><br /><span class="hljs-string" style="box-sizing: border-box; color: #2aa198;">MSG:</span> [cmd] arming <span class="hljs-string" style="box-sizing: border-box; color: #2aa198;">state:</span> ARMED<br /><span class="hljs-string" style="box-sizing: border-box; color: #2aa198;">MSG:</span> [sdlog2] log <span class="hljs-string" style="box-sizing: border-box; color: #2aa198;">dir:</span> <span class="hljs-regexp" style="box-sizing: border-box; color: #2aa198;">/fs/</span>microsd<span class="hljs-regexp" style="box-sizing: border-box; color: #2aa198;">/log/</span><span class="hljs-number" style="box-sizing: border-box; color: #2aa198;">2015</span>-<span class="hljs-number" style="box-sizing: border-box; color: #2aa198;">06</span>-<span class="hljs-number" style="box-sizing: border-box; color: #2aa198;">29</span><br /><span class="hljs-string" style="box-sizing: border-box; color: #2aa198;">MSG:</span> TAKEOFF DETECTED<br /><span class="hljs-string" style="box-sizing: border-box; color: #2aa198;">MSG:</span> [sdlog2] <span class="hljs-string" style="box-sizing: border-box; color: #2aa198;">starting:</span> <span class="hljs-number" style="box-sizing: border-box; color: #2aa198;">18</span>_55_11.px4log<br /></code></pre></li><li style="-webkit-font-feature-settings: 'kern' 1, 'onum' 1, 'liga' 1; box-sizing: border-box; margin-left: 1rem;">Push throttle stick up. The graphic of jMAVSim's simulated copter should now take off.</li></ol></div>
