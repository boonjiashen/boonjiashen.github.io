---
layout: post
title: 'UAV Software Recipes I: Hardware-in-the-loop simulation'
date: 2015-06-30 15:11:00.000000000 -07:00
type: post
published: true
status: publish
categories:
- UAV
tags: []
meta:
  _publicize_pending: '1'
  _publicize_job_id: '17336999892'
  blogger_blog: blog.jiashen.me
  blogger_author: Jia Shen Boon
  blogger_406b70948e1d03d2554041dda5a8b48e_permalink: '871585390835275053'
  _edit_last: '81887416'
  _syntaxhighlighter_encoded: '1'
  _jetpack_related_posts_cache: a:1:{s:32:"8f6677c9d6b0f903e98ad32ec61f8deb";a:2:{s:7:"expires";i:1464419385;s:7:"payload";a:3:{i:0;a:1:{s:2:"id";i:26;}i:1;a:1:{s:2:"id";i:15;}i:2;a:1:{s:2:"id";i:17;}}}}
  original_post_id: '8'
  _wp_old_slug: '8'
author:
  login: boonjiashen
  email: jiashen@gmail.com
  display_name: jiashen
  first_name: ''
  last_name: ''
---
<h2>Background</h2>
<p>Hey everybody! Today I want to write about simulating an unmanned aerial vehicle (UAV, popularly known as "drones") with hardware in the loop (HIL, HITL). I'm not sure about the nitty gritty details but as far as I can tell, HITL is when you place the flight stack that sits in your flight controller unit (FCU) in a simulated environment, i.e. you inject simulated sensory inputs into the flight stack and ask the flight stack to produce actuator outputs. This scenario is the same as software in the loop (SITL), except that in SITL, the flight stack in question is an instance that sits in your workstation, e.g. your laptop, rather than the actual one in your flight controller unit.</p>
<p>Why would you pick HITL over SITL? For one thing, since HITL involves the actual flight stack that you'll be flying with, it should give simulated results that are closer to real world flight results. On the other hand, SITL can be done with your laptop and nothing else; HITL requires you to connect your laptop to the FCU, which can be a pain if your UAV is bulky and cumbersome.</p>
<p>Again, I'm not 100% sure on the above, but it makes sense to me.</p>
<p>To provide some context, I've been working as a research assistant at a robotics lab at Wisconsin. These recipes are the crystallization of my poking around existing software libraries in the UAV world.</p>
<h1 id="uav-system-specifications">UAV system specifications</h1>
<p>Here's the hardware related specifications that I'm running on. You'll need the PX4 flight stack for this HITL, but everything else is swappable. For example, you can go with another FCU besides the Pixhawk.</p>
<ul>
<li>3DRobotics IRIS+ chassis</li>
<li>3DRobotics Pixhawk FCU</li>
<li>PX4 flight stack [<a href="https://github.com/PX4/Firmware">Github</a>] [<a href="https://pixhawk.org/start">Pixhawk</a>]</li>
<li>FrSky Taranis Plus remote control transmitter (RC transmitter)</li>
</ul>
<p>Note: the HITL that I'll be describing DOES NOT work with the Ardupilot/Arducopter flight stack. At the time of writing, Ardupilot only supports SITL. If you're using it, either switch to PX4 or be content with SITL.</p>
<h1 id="software-specifications">Software specifications</h1>
<ul>
<li>Ubuntu 14.04.1 on the workstation. I'll refer to this workstation as the ground control station or GCS.</li>
<li>jMAVSim simulator [<a href="https://github.com/DrTon/jMAVSim">Github</a>] [<a href="https://gitter.im/DrTon/jMAVSim">Gitter</a>]</li>
<li>qgroundcontrol GCS software [<a href="http://qgroundcontrol.org/">qgroundcontrol</a>]</li>
</ul>
<h1 id="how-to-run-the-simulator">How to run the simulator</h1>
<ol>
<li>Flash PX4 firmware to the Pixhawk using qgroundcontrol.</li>
<li>Perform initial calibration of PX4 using qgroundcontrol. Make sure to assign a channel to flight modes, because you'll have to set the mode to manual later during flight.</li>
<li>Change SYS_AUTOSTART parameter on PX4 to 1001.</li>
<li>Connect IRIS+ microUSB to GCS' USB</li>
<li>Compile and run Simulator.java.<br />
[code lang="bash"]<br />
cd<br />
ant # build simulator<br />
java -cp lib/*:out/production/jmavsim.jar me.drton.jmavsim.Simulator # run simulator<br />
[/code]
</li>
<li>Turn on RC transmitter and flip mode to manual. You should see something like:
<pre>MSG: Flight mode: MANUAL</pre>
</li>
<li>Arm Pixhawk via RC transmitter. You should see something like the following. Notice that it states TAKEOFF DETECTED even though my throttle stick is still down, which is weird.
<pre>MSG: ARMED by RC
MSG: home: 55.7533878, 37.6253804, 5.50
MSG: [cmd] arming state: ARMED
MSG: [sdlog2] log dir: /fs/microsd/log/2015-06-29
MSG: TAKEOFF DETECTED
MSG: [sdlog2] starting: 18_55_11.px4log</pre>
</li>
<li>Push throttle stick up. The graphic of jMAVSim's simulated copter should now take off.</li>
</ol>
