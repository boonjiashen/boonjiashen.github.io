---
layout: post
title: Laptop to Arduino over serial USB
date: '2013-09-02T01:38:00.001-07:00'
author: Jia Shen Boon
tags: 
modified_time: '2013-09-02T01:46:24.955-07:00'
blogger_id: tag:blogger.com,1999:blog-6651978490904982752.post-2636743991440636551
blogger_orig_url: http://blog.jiashen.me/2013/09/laptop-to-arduino-over-serial-usb.html
---

<br />The last time I wrote, I talked about how the Arduino seemed to be reading serial information slower than the Raspberry Pi was writing it.<br /><br />After reading the <a href="http://www.tldp.org/HOWTO/Serial-HOWTO-3.html">TLDP Serial HOWTO</a>, I learnt that my suspicion on the serial buffer is true: it is a FIFO queue. That makes it quite clear why my Arduino was lagging behind: because I intentionally added a few hundred milliseconds of delay after every read statement. As a result, the buffer is getting clogged with writes from the Raspberry Pi during this few hundred ms, and following that the Arduino reads the buffer just once.<br /><br />To recap: previously my Arduino code was something like this:<br /><blockquote><span style="font-family: &quot;Courier New&quot;,Courier,monospace;">char buffer = '\0';</span><br /><span style="font-family: &quot;Courier New&quot;,Courier,monospace;"></span><br /><span style="font-family: &quot;Courier New&quot;,Courier,monospace;">void setup(){</span><br /><span style="font-family: &quot;Courier New&quot;,Courier,monospace;">&nbsp; Serial.begin(9600);</span></blockquote><blockquote><span style="font-family: &quot;Courier New&quot;,Courier,monospace;">}<br /><br />void loop(){</span><br /><span style="font-family: &quot;Courier New&quot;,Courier,monospace;">&nbsp; if (Serial.available()){<br />&nbsp;&nbsp;&nbsp; buffer = Serial.read();</span><br /><span style="font-family: &quot;Courier New&quot;,Courier,monospace;">&nbsp; }</span><br /><span style="font-family: &quot;Courier New&quot;,Courier,monospace;">&nbsp; /*** Do some stuff here with buffer char ***/ </span><br /><span style="font-family: &quot;Courier New&quot;,Courier,monospace;">} </span></blockquote>Now <span style="font-family: &quot;Courier New&quot;,Courier,monospace;">loop()</span> is more like this:<br /><blockquote class="tr_bq"><span style="font-family: &quot;Courier New&quot;,Courier,monospace;">void loop(){</span></blockquote><blockquote><span style="font-family: &quot;Courier New&quot;,Courier,monospace;">&nbsp; while (Serial.available()){<br />&nbsp;&nbsp;&nbsp; buffer = Serial.read();</span><br /><span style="font-family: &quot;Courier New&quot;,Courier,monospace;">&nbsp; }</span><br /><span style="font-family: &quot;Courier New&quot;,Courier,monospace;">&nbsp; /*** Do some stuff here with buffer char ***/ </span><br /><span style="font-family: &quot;Courier New&quot;,Courier,monospace;">}&nbsp;</span></blockquote><span style="font-family: inherit;">If you couldn't tell the difference, I simply changed the <span style="font-family: &quot;Courier New&quot;,Courier,monospace;">if</span> keyword to <span style="font-family: &quot;Courier New&quot;,Courier,monospace;">while</span>, such that every time <span style="font-family: &quot;Courier New&quot;,Courier,monospace;">loop()</span> runs, the buffer is read till the last byte. Then we do things with that byte. Previously, only the head of the buffer queue was read for each run of <span style="font-family: &quot;Courier New&quot;,Courier,monospace;">loop()</span>, and that was the cause of the problems.</span><br /><span style="font-family: inherit;"><br /></span><span style="font-family: inherit;">The downside of this is that even if there was nothing left in the buffer, the <span style="font-family: &quot;Courier New&quot;,Courier,monospace;">buffer</span> variable will still contain the value from the previous <span style="font-family: &quot;Courier New&quot;,Courier,monospace;">Serial.read()</span> (since it's a global variable), and the <span style="font-family: &quot;Courier New&quot;,Courier,monospace;">/*** Do some stuff ***/</span> part will still run with this previous. This may not be the behaviour that you want, but for me it's fine.</span><br /><br /><span style="font-family: inherit;">And now I no longer have the lag issue.</span><br /><br /><span style="font-family: inherit;">On a separate note, I ordered a few more electronic parts from <a href="http://sg.element14.com/">Element 14</a>, including an <a href="http://arduino.cc/en/Main/ArduinoMotorShieldR3">Arduino motor shield</a>. It should be arriving today. I'm pretty excited about getting my robot up and running. The next challenge I face now is getting a good power supply for the Raspberry Pi, Arduino and the DC motors. I at least will need some form of <a href="http://en.wikipedia.org/wiki/Linear_regulator">voltage</a> <a href="http://en.wikipedia.org/wiki/Switching_regulator">regulation</a> for the Pi. I'm reading up on that now. Fingers crossed!</span>